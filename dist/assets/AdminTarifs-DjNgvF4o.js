import{j as e}from"./ui-vendor-CbTtZHsW.js";import{a as s,R as t}from"./react-vendor-1XlI0agO.js";import{a,b as r,c as i,C as l}from"./card-Cczuk04M.js";import{B as o}from"./button-BaBzPPdN.js";import{I as c}from"./input-Cyy5VwgS.js";import{L as n}from"./label-Dtbf7Pbr.js";import{b as d,L as u}from"./index-D1_jVxz0.js";import{b as m,c as p,d as h,S as f}from"./useTariffs-CO6o1QVA.js";import{u as x,w as g,F as j,r as v}from"./FileSaver.min-CmnGXiS0.js";import{U as w}from"./upload-DM0s_sQW.js";import{S as y}from"./save-Bu5et1U3.js";import{S as _}from"./search-B6TsrJyZ.js";import"./query-vendor-DL9dZapS.js";const b=({tariffs:s,search:t,setSearch:n,store:d,storeName:m,storeColor:p,saveTariffs:h,bulkUpdate:x,getLocalValue:g,updateLocalPrice:j,updateLocalIsActive:v,getLocalIsActive:w,hasChanges:b})=>e.jsxs(a,{children:[e.jsxs(r,{className:"pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 ${p} rounded-full flex items-center justify-center`,children:e.jsx(f,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsxs(i,{className:"text-lg",children:[m," Tariffs"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.length," wilayas"]})]})]}),e.jsxs(o,{onClick:h,disabled:x.isPending||!b,children:[x.isPending?e.jsx(u,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(y,{className:"w-4 h-4 mr-2"}),"Save Tariffs"]})]}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(_,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(c,{placeholder:"Search wilaya...",value:t,onChange:e=>n(e.target.value),className:"pl-10"})]})]}),e.jsx(l,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full table-fixed",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-muted/50",children:[e.jsx("th",{className:"w-2/6 text-center py-3 px-2 font-medium",children:"Wilaya"}),e.jsx("th",{className:"w-1/6 text-center py-3 px-2 font-medium",children:"Home"}),e.jsx("th",{className:"w-1/6 text-center py-3 px-2 font-medium",children:"Bureau"}),e.jsx("th",{className:"w-1/6 text-center py-3 px-2 font-medium",children:"Return"}),e.jsx("th",{className:"w-1/6 text-center py-3 px-2 font-medium",children:"Active"})]})}),e.jsx("tbody",{children:s.map((s,t)=>e.jsxs("tr",{className:t%2==0?"bg-muted/20":"",children:[e.jsxs("td",{className:"py-2 px-2 font-medium text-center",children:[s.wilaya_code," - ",s.wilaya_name]}),e.jsx("td",{className:"py-2 px-2 text-center",children:e.jsx(c,{type:"text",pattern:"[0-9]*",value:g(s,"home_price"),onChange:e=>{j(s.id,s,"home_price",e.target.value)},className:"w-full mx-auto text-center"})}),e.jsx("td",{className:"py-2 px-2 text-center",children:e.jsx(c,{type:"text",pattern:"[0-9]*",value:g(s,"bureau_price"),onChange:e=>{j(s.id,s,"bureau_price",e.target.value)},className:"w-full mx-auto text-center"})}),e.jsx("td",{className:"py-2 px-2 text-center",children:e.jsx(c,{type:"text",pattern:"[0-9]*",value:g(s,"retour"),onChange:e=>{j(s.id,s,"retour",e.target.value)},className:"w-full mx-auto text-center"})}),e.jsx("td",{className:"py-2 px-2 text-center",children:e.jsx("div",{className:"h-4 w-4 rounded-full mx-auto cursor-pointer transition-colors duration-200 "+(w(s)?"bg-gray-400":"bg-deep-red"),onClick:()=>v(s.id,s,!w(s))})})]},s.id))})]})})})]}),N=()=>{const{data:f=[],isLoading:y}=m(),_=p(),N=h(),{toast:S}=d(),[C,L]=s.useState(""),[I,A]=s.useState(""),[k,F]=s.useState(!1),[T,$]=s.useState(null),[E,P]=s.useState([]),[U,B]=s.useState({}),R=f.filter(e=>"laghouat"===e.store),V=f.filter(e=>"aflou"===e.store),D=(e,s)=>{const t=U[e.id]?.[s]??e[s];return String(t)},M=e=>U[e.id]?.is_active??e.is_active??!0,O=(e,s,t,a)=>{F(!0),B(r=>{const i=r[e]||{home_price:s.home_price,bureau_price:s.bureau_price,retour:s.retour,is_active:s.is_active};return{...r,[e]:{...i,[t]:a}}})},W=(e,s,t)=>{F(!0),B(a=>{const r={...a},i=r[e]||{home_price:s.home_price,bureau_price:s.bureau_price,retour:s.retour,is_active:s.is_active};r[e]={...i,is_active:t};const l="laghouat"===s.store?"aflou":"laghouat",o=f.find(e=>e.wilaya_code===s.wilaya_code&&e.store===l);if(o){const e=r[o.id]||{home_price:o.home_price,bureau_price:o.bureau_price,retour:o.retour,is_active:o.is_active};r[o.id]={...e,is_active:t}}return r})},q=async()=>{const e=f.filter(e=>U[e.id]&&((U[e.id]?.home_price??e.home_price)!==e.home_price||(U[e.id]?.bureau_price??e.bureau_price)!==e.bureau_price||(U[e.id]?.retour??e.retour)!==e.retour||(U[e.id]?.is_active??e.is_active)!==e.is_active)).map(e=>({id:e.id,home_price:parseFloat(String(U[e.id]?.home_price??e.home_price))||void 0,bureau_price:parseFloat(String(U[e.id]?.bureau_price??e.bureau_price))||void 0,retour:parseFloat(String(U[e.id]?.retour??e.retour))||void 0,is_active:(void 0===U[e.id]?.is_active?e.is_active:U[e.id]?.is_active)??void 0}));if(0!==e.length)try{await _.mutateAsync(e),F(!1),B(s=>{const t={...s};return e.forEach(e=>delete t[e.id]),t}),S({title:"Saved",description:"All tariffs saved successfully"})}catch(s){S({title:"Error",description:"Failed to save tariffs",variant:"destructive"})}else S({title:"No changes",description:"No tariffs were modified"})},z=t.useMemo(()=>R.filter(e=>e.wilaya_name.toLowerCase().includes(C.toLowerCase())||String(e.wilaya_code).includes(C)),[R,C]),H=t.useMemo(()=>V.filter(e=>e.wilaya_name.toLowerCase().includes(I.toLowerCase())||String(e.wilaya_code).includes(I)),[V,I]);return y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(u,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Tariffs"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage delivery prices for each wilaya per store"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Note:"})," The store with the lowest delivery price is automatically selected at checkout. If prices are equal, Laghouat is selected by default."]})}),e.jsxs(a,{children:[e.jsxs(r,{children:[e.jsx(i,{className:"text-lg",children:"Bulk Import Tariffs"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload a CSV or Excel file to update tariffs."})]}),e.jsxs(l,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsx(o,{onClick:()=>{const e=[["wilaya_code","wilaya_name","home_price","bureau_price","retour","store"],["16","Algiers","300","250","50","laghouat"],["16","Algiers","350","300","60","aflou"]],s=x.aoa_to_sheet(e),t=x.book_new();x.book_append_sheet(t,s,"Tariffs");const a=g(t,{bookType:"xlsx",type:"array"}),r=new Blob([a],{type:"application/octet-stream"});j.saveAs(r,"tariffs_template.xlsx")},className:"w-full sm:w-auto",children:"Download Template"}),e.jsxs("div",{className:"relative w-full sm:w-auto flex-grow",children:[e.jsx(n,{htmlFor:"tariff-upload",className:"flex items-center justify-center h-10 w-full sm:w-auto cursor-pointer rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground",children:T?T.name:"Choose file..."}),e.jsx(c,{id:"tariff-upload",type:"file",accept:".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel",onChange:s=>{const t=s.target.files?.[0];if(!t)return $(null),void P([]);$(t);const a=new FileReader;a.onload=s=>{try{const a=s.target?.result,r=v(a,{type:"binary"}),i=r.SheetNames[0],l=r.Sheets[i],o=x.sheet_to_json(l),c=[],n=[];o.forEach((e,s)=>{const t=s+2,a={};let r=!0;"number"!=typeof e.wilaya_code||isNaN(e.wilaya_code)?(n.push(`Row ${t}: 'wilaya_code' is missing or invalid.`),r=!1):a.wilaya_code=e.wilaya_code,"string"==typeof e.wilaya_name&&""!==e.wilaya_name.trim()?a.wilaya_name=e.wilaya_name.trim():(n.push(`Row ${t}: 'wilaya_name' is missing or invalid.`),r=!1),["home_price","bureau_price","retour"].forEach(s=>{const i=parseFloat(e[s]);!isNaN(i)&&i>=0?a[s]=i:(n.push(`Row ${t}: '${s}' is missing or invalid (must be a non-negative number).`),r=!1)}),"string"==typeof e.store&&["laghouat","aflou"].includes(e.store.toLowerCase())?a.store=e.store.toLowerCase():(n.push(`Row ${t}: 'store' is missing or invalid (must be 'laghouat' or 'aflou').`),r=!1),r&&c.push(a)}),P(c),n.length>0?S({title:"File Uploaded with Warnings/Errors",description:e.jsxs("div",{children:[e.jsxs("p",{children:[t.name," parsed. Some rows have issues:"]}),e.jsxs("ul",{className:"list-disc pl-5",children:[n.slice(0,5).map((s,t)=>e.jsx("li",{children:s},t)),n.length>5&&e.jsxs("li",{children:["And ",n.length-5," more errors..."]})]})]}),variant:"destructive",duration:9e3}):S({title:"File Uploaded Successfully",description:`${t.name} parsed. ${c.length} valid rows found.`})}catch(a){S({title:"Error reading file",description:a.message||"Could not parse the uploaded file. Ensure it's a valid CSV/Excel format.",variant:"destructive",duration:9e3}),$(null),P([])}},a.onerror=()=>{S({title:"Error",description:"Failed to read file.",variant:"destructive"}),$(null),P([])},a.readAsBinaryString(t)},className:"sr-only"})]}),e.jsxs(o,{onClick:async()=>{if(0!==E.length)try{const s=await N.mutateAsync(E);let t="";s.successfulInserts>0&&(t+=`${s.successfulInserts} new tariffs inserted. `),s.successfulUpdates>0&&(t+=`${s.successfulUpdates} existing tariffs updated. `),s.failedImports.length>0?(t+=`${s.failedImports.length} tariffs failed to import.`,S({title:"Bulk Import Completed with Errors",description:e.jsxs("div",{children:[e.jsx("p",{children:t}),e.jsxs("ul",{className:"list-disc pl-5",children:[s.failedImports.slice(0,3).map((s,t)=>e.jsxs("li",{children:["Wilaya ",s.tariff.wilaya_code," (",s.tariff.store,"): ",s.error]},t)),s.failedImports.length>3&&e.jsxs("li",{children:["And ",s.failedImports.length-3," more failures..."]})]})]}),variant:"destructive",duration:9e3})):S({title:"Bulk Import Successful",description:t||"All tariffs imported successfully."}),$(null),P([])}catch(s){S({title:"Bulk Import Failed",description:s.message||"An unexpected error occurred during import.",variant:"destructive"})}else S({title:"No data to import",description:"Please upload a valid file with tariff data.",variant:"destructive"})},disabled:0===E.length||N.isPending,className:"w-full sm:w-auto",children:[N.isPending?e.jsx(u,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(w,{className:"w-4 h-4 mr-2"}),"Import Tariffs (",E.length," rows)"]})]}),E.length>0&&e.jsxs("div",{className:"border rounded-md p-4 max-h-60 overflow-y-auto",children:[e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Preview Data (",E.length," rows)"]}),e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsx("tr",{className:"bg-muted/50",children:Object.keys(E[0]).map(s=>e.jsx("th",{className:"py-2 px-3 text-center font-medium",children:s},s))})}),e.jsxs("tbody",{children:[E.slice(0,5).map((s,t)=>e.jsx("tr",{className:"border-t",children:Object.values(s).map((s,t)=>e.jsx("td",{className:"py-2 px-3 text-center",children:String(s)},t))},t)),E.length>5&&e.jsx("tr",{children:e.jsxs("td",{colSpan:Object.keys(E[0]).length,className:"text-center py-2 text-muted-foreground",children:["... ",E.length-5," more rows"]})})]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[e.jsx(b,{tariffs:z,search:C,setSearch:L,store:"laghouat",storeName:"Laghouat",storeColor:"bg-primary",saveTariffs:q,bulkUpdate:_,getLocalValue:D,updateLocalPrice:O,updateLocalIsActive:W,getLocalIsActive:M,hasChanges:k}),e.jsx(b,{tariffs:H,search:I,setSearch:A,store:"aflou",storeName:"Aflou",storeColor:"bg-orange-500",saveTariffs:q,bulkUpdate:_,getLocalValue:D,updateLocalPrice:O,updateLocalIsActive:W,getLocalIsActive:M,hasChanges:k})]})]})};export{N as default};
